<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <script type="module" src="firebase.js"></script>
  <meta charset="UTF-8">
  <title>Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: center; padding: 12px; border: 1px solid #e5e7eb; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow-lg space-y-8">
    <h1 class="text-4xl font-bold text-center text-blue-800">ğŸ“š Ù…Ù„Ù Ø§Ù„Ù„Ø§Ø¹Ø¨</h1>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ -->
    <div id="playerInfo" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 text-lg"></div>

    <!-- Ø³Ø¬Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ø¹ Ø²Ø± -->
    <div>
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-2xl font-bold text-blue-700">ğŸ—‚ï¸ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h2>
        <button onclick="addSubscription()" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 text-sm">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</button>
      </div>
      <ul id="subscriptionsList" class="list-disc pr-6 text-gray-600 text-base space-y-1"></ul>
    </div>

    <!-- Ø§Ù„ØªÙ‚Ø¯Ù… -->
    <div id="progress" class="text-center text-xl font-semibold text-green-600"></div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† -->
    <div>
      <h2 class="text-2xl font-bold text-blue-700 mb-4">ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border border-gray-300 rounded-xl">
          <thead class="bg-blue-100 text-blue-900">
            <tr>
              <th>Ø§Ù„ÙŠÙˆÙ…</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</th>
              <th>Ø§Ù„Ø­Ø¶ÙˆØ±</th>
              <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="weeklyTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ØªÙ…Ø±ÙŠÙ† -->
    <div class="border-t pt-6">
      <h3 class="text-xl font-bold mb-4">â• Ø¥Ø¶Ø§ÙØ© ØªÙ…Ø±ÙŠÙ†</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Ø§Ù„ÙŠÙˆÙ…</label>
          <div class="grid grid-cols-2 gap-2">
            <button class="day-btn bg-gray-200 px-3 py-2 rounded hover:bg-blue-300" data-day="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</button>
            <button class="day-btn bg-gray-200 px-3 py-2 rounded hover:bg-blue-300" data-day="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</button>
            <button class="day-btn bg-gray-200 px-3 py-2 rounded hover:bg-blue-300" data-day="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</button>
            <button class="day-btn bg-gray-200 px-3 py-2 rounded hover:bg-blue-300" data-day="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</button>
            <button class="day-btn bg-gray-200 px-3 py-2 rounded hover:bg-blue-300" data-day="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</button>
            <button class="day-btn bg-gray-200 px-3 py-2 rounded hover:bg-blue-300" data-day="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</button>
            <button class="day-btn bg-gray-200 px-3 py-2 rounded hover:bg-blue-300" data-day="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</button>
          </div>
        </div>

        <input id="dateInput" type="date" class="p-2 border rounded">
        <input id="timeInput" type="time" class="p-2 border rounded">

        <select id="typeInput" class="p-2 border rounded">
          <option value="">Ù†ÙˆØ¹ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
          <option value="××™××•×Ÿ ×›×•×—">××™××•×Ÿ ×›×•×—</option>
          <option value="××™××•×Ÿ ×¨×™×©×•×Ÿ 50 ×©×—">××™××•×Ÿ ×¨×™×©×•×Ÿ 50 ×©×—</option>
          <option value="××™××•×Ÿ ××™×©×™">××™××•×Ÿ ××™×©×™</option>
        </select>

        <label class="flex items-center gap-2">
          <input type="checkbox" id="cameInput">
          <span>âœ… Ø£ØªÙ‰</span>
        </label>
      </div>
      <button id="addTraining" class="mt-4 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Ø­ÙØ¸ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</button>
    </div>

    <a href="index.html" class="block text-center text-blue-600 hover:underline">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
  </div>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
  <script type="module">
    import { db } from './firebase.js';
    import { collection, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* =============== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© =============== */
    const playerId = new URLSearchParams(location.search).get("id");
    const playerRef = doc(db, "players", playerId);

    let player;
    const playerInfo   = document.getElementById("playerInfo");
    const subsList     = document.getElementById("subscriptionsList");
    const progress     = document.getElementById("progress");
    const weeklyTable  = document.getElementById("weeklyTable");

    const dayInputButtons = document.querySelectorAll(".day-btn");
    const dateInput       = document.getElementById("dateInput");
    const timeInput       = document.getElementById("timeInput");
    const typeInput       = document.getElementById("typeInput");
    const cameInput       = document.getElementById("cameInput");

    let selectedDay = "";

    /* =============== Ù…Ø³Ø§Ø¹Ø¯ Ù„Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± =============== */
    dayInputButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        selectedDay = btn.dataset.day;
        dayInputButtons.forEach(b => b.classList.remove("bg-blue-500", "text-white"));
        btn.classList.add("bg-blue-500", "text-white");

        const dayMap = {
          'Ø§Ù„Ø£Ø­Ø¯': 0, 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†': 1, 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡': 2,
          'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡': 3, 'Ø§Ù„Ø®Ù…ÙŠØ³': 4, 'Ø§Ù„Ø¬Ù…Ø¹Ø©': 5, 'Ø§Ù„Ø³Ø¨Øª': 6
        };
        const today       = new Date();
        const todayIndex  = today.getDay();
        const targetIndex = dayMap[selectedDay];
        let diff = (targetIndex - todayIndex + 7) % 7;
        if (diff < 2) diff += 7; // Ù„ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ø¶Ø±
        const targetDate  = new Date(today.getFullYear(), today.getMonth(), today.getDate() + diff);
        dateInput.value   = targetDate.toISOString().split("T")[0];
      });
    });

    /* =============== ØªØ­ÙˆÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¥Ù„Ù‰ ØªØ³Ù…ÙŠØ© =============== */
    function getSubscriptionLabel(value) {
      switch (value) {
        case "15": return "15 ØªÙ…Ø±ÙŠÙ† - 1500 Ø´ÙŠÙƒÙ„";
        case "35": return "35 ØªÙ…Ø±ÙŠÙ† - 3000 Ø´ÙŠÙƒÙ„";
        case "50": return "50 ØªÙ…Ø±ÙŠÙ† - 4000 Ø´ÙŠÙƒÙ„";
        default:   return "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      }
    }

    /* =============== Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø­Ø¶ÙˆØ± =============== */
    async function showInfo() {
      const snap = await getDoc(playerRef);
      if (!snap.exists()) {
        document.body.innerHTML = '<p class="text-red-600 text-center text-xl mt-10">âŒ Ø§Ù„Ù„Ø§Ø¹Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
        return;
      }
      player = snap.data();
      player.attendance    = player.attendance    || [];
      player.subscriptions = player.subscriptions || [];

      /* Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© */
      playerInfo.innerHTML = `
        <div>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${player.name   || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}</div>
        <div>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${player.phone  || "-"}</div>
        <div>ğŸ“ Ø§Ù„Ø·ÙˆÙ„:  ${player.height || "-"} Ø³Ù…</div>
        <div>âš–ï¸ Ø§Ù„ÙˆØ²Ù†:  ${player.weight || "-"} ÙƒØº</div>
        <div>ğŸ‚ Ø§Ù„Ø¹Ù…Ø±:  ${player.age    || "-"}</div>
      `;

      /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ø¹ Ø²Ø± Ø­Ø°Ù */
      subsList.innerHTML = `
        ${player.subscription ? `<li class="text-gray-700">ğŸ“Œ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø£ÙˆÙ„ÙŠ: ${getSubscriptionLabel(player.subscription)}</li>` : ""}
      ` + player.subscriptions.map((sub, i) => `
        <li class="flex justify-between items-center">
          <span>${sub.date} - ${getSubscriptionLabel(sub.type)}</span>
          <button onclick="deleteSubscription(${i})" class="text-red-600 hover:text-red-800" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
        </li>
      `).join("");

      /* Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù… */
      const total     = parseInt(player.subscriptions.at(-1)?.type || player.subscription || "0");
      const attended  = player.attendance.filter(a => a.came).length;
      progress.textContent = total ? `âœ… ØªÙ… ${attended} Ù…Ù† ${total} ØªÙ…Ø±ÙŠÙ†` : "ğŸ“Œ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§Ùƒ Ù…ÙØ¹Ù„";

      showTable();
    }

    /* =============== ØªÙ„ÙˆÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„ØªÙ…Ø±ÙŠÙ† ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ =============== */
    function getTypeColor(type) {
      if (type === "××™××•×Ÿ ×›×•×—")         return "bg-blue-50 text-blue-700";
      if (type === "××™××•×Ÿ ×¨×™×©×•×Ÿ 50 ×©×—") return "bg-yellow-50 text-yellow-700";
      if (type === "××™××•×Ÿ ××™×©×™")        return "bg-green-50 text-green-700";
      return "bg-gray-100 text-gray-700";
    }

    /* =============== Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù =============== */
    function showTable() {
      weeklyTable.innerHTML = "";
      player.attendance.forEach((a, i) => {
        const row = document.createElement("tr");
        row.className = getTypeColor(a.type);
        row.innerHTML = `
          <td>${a.day}</td>
          <td>${a.date}</td>
          <td>${a.time}</td>
          <td>${a.type}</td>
          <td>${a.came ? "âœ… Ø£ØªÙ‰" : "âŒ Ù„Ù… ÙŠØ£ØªÙŠ"}</td>
          <td class="flex gap-2 justify-center">
            <button onclick="toggleAttendance(${i})" class="text-blue-600 hover:underline text-sm" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±">ØªØ¨Ø¯ÙŠÙ„</button>
            <button onclick="deleteTraining(${i})"  class="text-red-600 hover:text-red-800 text-sm" title="Ø­Ø°Ù Ø§Ù„ØªÙ…Ø±ÙŠÙ†">ğŸ—‘ï¸</button>
          </td>
        `;
        weeklyTable.appendChild(row);
      });
    }

    /* =============== Ø¥Ø¶Ø§ÙØ© ØªÙ…Ø±ÙŠÙ† Ø¬Ø¯ÙŠØ¯ =============== */
    document.getElementById("addTraining").onclick = async () => {
      if (!dateInput.value || !timeInput.value || !typeInput.value) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙˆÙ†ÙˆØ¹ Ø§Ù„ØªÙ…Ø±ÙŠÙ†.");
        return;
      }

      let dayName = selectedDay;
      if (!dayName) {
        const date = new Date(dateInput.value);
        const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        dayName = dayNames[date.getDay()];
      }

      const newTraining = {
        day:  dayName,
        date: dateInput.value,
        time: timeInput.value,
        type: typeInput.value,
        came: cameInput.checked
      };

      player.attendance.push(newTraining);
      await updateDoc(playerRef, { attendance: player.attendance });
      showInfo();

      /* Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ */
      selectedDay = "";
      dayInputButtons.forEach(b => b.classList.remove("bg-blue-500", "text-white"));
      dateInput.value = "";
      timeInput.value = "";
      typeInput.value = "";
      cameInput.checked = false;
    };

    /* =============== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØ¨Ø¯ÙŠÙ„ ================= */

    /** Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ **/
    function addSubscription() {
      const choice = prompt(
        "Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:\n1) 15 ØªÙ…Ø±ÙŠÙ† - 1500 Ø´ÙŠÙƒÙ„\n2) 35 ØªÙ…Ø±ÙŠÙ† - 3000 Ø´ÙŠÙƒÙ„\n3) 50 ØªÙ…Ø±ÙŠÙ† - 4000 Ø´ÙŠÙƒÙ„"
      );
      let typeValue;
      if (choice === "1" || choice === "15")      typeValue = "15";
      else if (choice === "2" || choice === "35") typeValue = "35";
      else if (choice === "3" || choice === "50") typeValue = "50";
      else return; // Ø¥Ù„ØºØ§Ø¡ Ø£Ùˆ Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©

      const today = new Date().toLocaleDateString('he-IL');
      const newSub = { date: today, type: typeValue };

      player.subscriptions.push(newSub);
      updateDoc(playerRef, { subscriptions: player.subscriptions }).then(showInfo);
    }
    window.addSubscription = addSubscription;

    /** Ø­Ø°Ù Ø§Ø´ØªØ±Ø§Ùƒ **/
    function deleteSubscription(idx) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŸ")) return;
      player.subscriptions.splice(idx, 1);
      updateDoc(playerRef, { subscriptions: player.subscriptions }).then(showInfo);
    }
    window.deleteSubscription = deleteSubscription;

    /** ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ± **/
    function toggleAttendance(idx) {
      player.attendance[idx].came = !player.attendance[idx].came;
      updateDoc(playerRef, { attendance: player.attendance }).then(showInfo);
    }
    window.toggleAttendance = toggleAttendance;

    /** Ø­Ø°Ù ØªÙ…Ø±ÙŠÙ† **/
    function deleteTraining(idx) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ…Ø±ÙŠÙ†ØŸ")) return;
      player.attendance.splice(idx, 1);
      updateDoc(playerRef, { attendance: player.attendance }).then(showInfo);
    }
    window.deleteTraining = deleteTraining;

    /* =============== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© =============== */
    showInfo();
  </script>
</body>
</html>
