<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>EMS • حضور اللاعبين</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- ░░░ شريط اختيار اللغة ░░░ -->
<div id="langSwitcher" class="fixed top-3 left-3 z-50 flex gap-2">
  <button data-lang="ar" class="lang-btn bg-gray-300 px-2 py-1 rounded hover:bg-gray-400">عربي</button>
  <button data-lang="he" class="lang-btn bg-gray-300 px-2 py-1 rounded hover:bg-gray-400">עברית</button>
</div>

<!-- ░░ صفحة تسجيل الدخول ░░ -->
<section id="loginPage" class="flex flex-col items-center justify-center min-h-screen space-y-6">
  <div class="w-full max-w-sm bg-white rounded-xl shadow-md p-8 space-y-6">
    <div class="text-center space-y-2">
      <img src="https://upload.wikimedia.org/wikipedia/commons/9/94/Ems_Logo.png" alt="EMS Logo" class="mx-auto w-20">
      <h1 id="loginTitle" class="text-2xl font-bold text-gray-800">تسجيل الدخول</h1>
      <p id="singleUserNote" class="text-sm text-gray-500">اسم مستخدم واحد فقط</p>
    </div>

    <form id="loginForm" class="space-y-4">
      <div>
        <label id="usernameLabel" class="block text-sm mb-1 text-gray-700">اسم المستخدم</label>
        <input id="username" type="text" dir="ltr"
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
               placeholder="leo" required>
      </div>

      <div>
        <label id="passwordLabel" class="block text-sm mb-1 text-gray-700">كلمة المرور</label>
        <input id="password" type="password" dir="ltr"
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400"
               placeholder="●●●●●●●●" required>
      </div>

      <button id="loginButton" type="submit"
              class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">
        تسجيل الدخول
      </button>
      <p id="loginError" class="hidden text-center text-red-600 text-sm mt-2">بيانات غير صحيحة</p>
    </form>
  </div>
</section>

<!-- ░░ صفحة التطبيق (تُخفى إلى أن يُسجَّل الدخول) ░░ -->
<section id="appPage" class="hidden">
  <div class="max-w-4xl mx-auto p-6 space-y-6">

    <!-- العنوان -->
    <div class="text-center">
      <img src="https://upload.wikimedia.org/wikipedia/commons/9/94/Ems_Logo.png" alt="EMS Logo" class="mx-auto w-24 mb-4">
      <h1 id="appTitle" class="text-3xl font-bold text-gray-800">سجل حضور لاعبي EMS</h1>
    </div>

    <!-- مربع البحث -->
    <div class="text-center">
      <input id="searchInput" type="text" placeholder="🔍 ابحث عن لاعب..."
             class="w-full max-w-md border border-gray-300 rounded-md p-2 text-center shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
    </div>

    <!-- زر إضافة لاعب -->
    <div class="text-center">
      <button id="addBtn" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">
        ➕ أضف لاعب جديد
      </button>
    </div>

    <!-- الحاوية الرئيسية للاعبين -->
    <div id="playersContainer" class="space-y-6"></div>
  </div>
</section>

<!-- ░░ الترجمات واللغة ░░ -->
<script>
const translations = {
  ar: {
    loginTitle: "تسجيل الدخول",
    singleUserNote: "اسم مستخدم واحد فقط",
    usernameLabel: "اسم المستخدم",
    passwordLabel: "كلمة المرور",
    loginButton: "تسجيل الدخول",
    loginError: "بيانات غير صحيحة",
    appTitle: "سجل حضور لاعبي EMS",
    searchPlaceholder: "🔍 ابحث عن لاعب...",
    addPlayerButton: "➕ أضف لاعب جديد",
    playerCardTitle: "لاعب EMS",
    deletePlayer: "🗑️ حذف اللاعب",
    playerNameLabel: "اسم اللاعب",
    playerPlaceholder: "مثلاً: أحمد",
    subscriptionLabel: "نوع الاشتراك",
    chooseSubscription: "اختر نوع الاشتراك",
    subscriptionTrial: "1 يوم واحد - 50 شيكل (تجربة)",
    subscription15: "15 تمرين - 1500 شيكل",
    subscription35: "35 تمرين - 3500 شيكل",
    subscription50: "50 تمرين - 4000 شيكل",
    subscriptionOther: "أخرى (أدخل يدويًا)",
    otherDetailsPlaceholder: "أدخل تفاصيل الاشتراك",
    dateLabel: "تاريخ التمرين",
    timeLabel: "وقت التمرين",
    addDateButton: "➕ أضف التاريخ والوقت",
    attendanceDatesTitle: "تواريخ الحضور:",
    trialAttendanceText: "1 يوم واحد - 50 شيكل (تجربة)",
    atTime: "الساعة",
    came: "✅ أتى",
    notCame: "❌ لم يأتِ",
    deleteTraining: "🗑️ حذف",
    deleteTrainingConfirm: "حذف هذا التمرين؟",
    deletePlayerConfirm: "هل تريد حذف هذا اللاعب؟"
  },
  he: {
    loginTitle: "התחברות",
    singleUserNote: "משתמש אחד בלבד",
    usernameLabel: "שם משתמש",
    passwordLabel: "סיסמה",
    loginButton: "התחבר",
    loginError: "פרטים שגויים",
    appTitle: "רישום נוכחות שחקני EMS",
    searchPlaceholder: "🔍 חפש שחקן...",
    addPlayerButton: "➕ הוסף שחקן חדש",
    playerCardTitle: "שחקן EMS",
    deletePlayer: "🗑️ מחק שחקן",
    playerNameLabel: "שם השחקן",
    playerPlaceholder: "לדוגמה: אחמד",
    subscriptionLabel: "סוג מנוי",
    chooseSubscription: "בחר סוג מנוי",
    subscriptionTrial: "יום אחד - 50 ₪ (ניסיון)",
    subscription15: "15 אימונים - 1500 ₪",
    subscription35: "35 אימונים - 3500 ₪",
    subscription50: "50 אימונים - 4000 ₪",
    subscriptionOther: "אחר (הזן ידנית)",
    otherDetailsPlaceholder: "הזן פרטי מנוי",
    dateLabel: "תאריך אימון",
    timeLabel: "שעת אימון",
    addDateButton: "➕ הוסף תאריך ושעה",
    attendanceDatesTitle: "תאריכי נוכחות:",
    trialAttendanceText: "יום אחד - 50 ₪ (ניסיון)",
    atTime: "בשעה",
    came: "✅ הגיע",
    notCame: "❌ לא הגיע",
    deleteTraining: "🗑️ מחק",
    deleteTrainingConfirm: "למחוק את האימון הזה?",
    deletePlayerConfirm: "למחוק את השחקן הזה?"
  }
};

const days = {
  ar: ["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"],
  he: ["יום א׳","יום ב׳","יום ג׳","יום ד׳","יום ה׳","יום ו׳","שבת"]
};

let currentLang = localStorage.getItem("emsLang") || "ar";
function t(k){ return translations[currentLang][k] || k; }
document.documentElement.lang = currentLang;
document.documentElement.dir  = "rtl";

/* تمييز زر اللغة الحالي */
function highlightLangButtons(){
  document.querySelectorAll(".lang-btn").forEach(btn=>{
    const active = btn.dataset.lang === currentLang;
    btn.classList.toggle("bg-blue-600", active);
    btn.classList.toggle("text-white", active);
  });
}

/* تبديل اللغة */
document.addEventListener("DOMContentLoaded", ()=>{
  document.querySelectorAll(".lang-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const sel = btn.dataset.lang;
      if (sel !== currentLang){
        localStorage.setItem("emsLang", sel);
        location.reload();
      }
    });
  });
  highlightLangButtons();
});
</script>

<!-- ░░ منطق تسجيل الدخول ░░ -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* عناصر أساسية */
  const loginPage = document.getElementById("loginPage");
  const appPage   = document.getElementById("appPage");
  const loginForm = document.getElementById("loginForm");
  const loginErr  = document.getElementById("loginError");

  /* ترجمة واجهة تسجيل الدخول */
  function updateLoginTexts(){
    document.getElementById("loginTitle").textContent    = t("loginTitle");
    document.getElementById("singleUserNote").textContent= t("singleUserNote");
    document.getElementById("usernameLabel").textContent = t("usernameLabel");
    document.getElementById("passwordLabel").textContent = t("passwordLabel");
    document.getElementById("loginButton").textContent   = t("loginButton");
    loginErr.textContent = t("loginError");
  }
  updateLoginTexts();

  /* إذا كان مسجَّل دخول سابقًا */
  if (sessionStorage.getItem("loggedIn") === "true") {
    loginPage.classList.add("hidden");
    appPage.classList.remove("hidden");
    updateAppTexts();               // ← تعريب التطبيق
  }

  /* التحقق من بيانات الدخول */
  loginForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const u = document.getElementById("username").value.trim();
    const p = document.getElementById("password").value;
    if (u === "leo" && p === "m22558800") {
      sessionStorage.setItem("loggedIn","true");
      loginErr.classList.add("hidden");
      loginPage.classList.add("hidden");
      appPage.classList.remove("hidden");
      updateAppTexts();
    } else {
      loginErr.classList.remove("hidden");
    }
  });
});
</script>

<!-- ░░ التطبيق: سجل اللاعبين ░░ -->
<script>
/* مفاتيح التخزين */
const STORAGE_KEY = "emsPlayers";

/* عناصر ثابتة */
const playersContainer = document.getElementById("playersContainer");
const searchInput      = document.getElementById("searchInput");
const addBtn           = document.getElementById("addBtn");
const appTitle         = document.getElementById("appTitle");

/* نصوص ثابتة للتطبيق */
function updateAppTexts(){
  appTitle.textContent             = t("appTitle");
  searchInput.placeholder          = t("searchPlaceholder");
  addBtn.textContent               = t("addPlayerButton");
}

/* --- أدوات مساعدة --- */
function today(){ return new Date().toISOString().split("T")[0]; }
function formatDateWithDay(d){
  const dt = new Date(d);
  return `${d} - ${days[currentLang][dt.getDay()]}`;
}

/* تحميل اللاعبين */
function loadFromStorage(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch{ return []; }
}
function saveToStorage(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
}

/* ترحيل قيم الاشتراك القديمة إلى الرموز الجديدة */
function migrateSubscriptionType(v){
  if (["1 يوم - 50 شيكل تجربة","יום אחד - 50 ₪ (ניסיון)","trial"].includes(v)) return "trial";
  if (["15 تمرين - 1500 شيكل","15 אימונים - 1500 ₪","15"].includes(v))       return "15";
  if (["35 تمرين - 3500 شيكل","35 אימונים - 3500 ₪","35"].includes(v))       return "35";
  if (["50 تمرين - 4000 شيكل","50 אימונים - 4000 ₪","50"].includes(v))       return "50";
  return v;
}

/* الحالة العامّة */
let players = loadFromStorage();
players.forEach(p=>{ p.subscriptionType = migrateSubscriptionType(p.subscriptionType||""); });

/* إنشاء بطاقة لاعب */
function renderPlayerCard(player){
  const card = document.createElement("div");
  card.className = "bg-white p-6 rounded-xl shadow-md space-y-4 border border-gray-200";
  card.dataset.id = player.id;

  card.innerHTML = `
    <div class="flex justify-between items-center">
      <h2 class="text-lg font-bold text-gray-700">${t("playerCardTitle")}</h2>
      <button class="delete-player text-red-600 hover:text-red-800 text-sm">${t("deletePlayer")}</button>
    </div>

    <div>
      <label class="block text-sm text-gray-700 mb-1">${t("playerNameLabel")}</label>
      <input type="text" class="player-name w-full p-2 border border-gray-300 rounded-md"
             placeholder="${t("playerPlaceholder")}" value="${player.name||''}" required>
    </div>

    <div>
      <label class="block text-sm text-gray-700 mb-1">${t("subscriptionLabel")}</label>
      <select class="subscription-select w-full p-2 border border-gray-300 rounded-md">
        <option value="">${t("chooseSubscription")}</option>
        <option value="trial">${t("subscriptionTrial")}</option>
        <option value="15">${t("subscription15")}</option>
        <option value="35">${t("subscription35")}</option>
        <option value="50">${t("subscription50")}</option>
        <option value="other">${t("subscriptionOther")}</option>
      </select>
      <textarea class="subscription-other w-full h-20 mt-2 border border-gray-300 rounded-md p-2 text-sm ${player.subscriptionType==='other'?'':'hidden'}"
        placeholder="${t("otherDetailsPlaceholder")}">${player.subscriptionOther||''}</textarea>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
      <div>
        <label class="block text-sm text-gray-700 mb-1">${t("dateLabel")}</label>
        <input type="date" class="date-input border border-gray-300 rounded-md p-2 w-full" value="${today()}">
      </div>
      <div>
        <label class="block text-sm text-gray-700 mb-1">${t("timeLabel")}</label>
        <input type="time" class="time-input border border-gray-300 rounded-md p-2 w-full">
      </div>
      <div class="pt-6 md:pt-0">
        <button type="button" class="add-date bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 w-full">
          ${t("addDateButton")}
        </button>
      </div>
    </div>

    <div>
      <h3 class="font-semibold text-gray-700 mb-2">${t("attendanceDatesTitle")}</h3>
      <ul class="dates-list pr-2 text-sm text-gray-800 space-y-2"></ul>
    </div>
  `;

  /* مراجع */
  const nameInput   = card.querySelector(".player-name");
  const subSelect   = card.querySelector(".subscription-select");
  const subOtherBox = card.querySelector(".subscription-other");
  const addDateBtn  = card.querySelector(".add-date");
  const dateInput   = card.querySelector(".date-input");
  const timeInput   = card.querySelector(".time-input");
  const datesUL     = card.querySelector(".dates-list");

  subSelect.value = player.subscriptionType || "";

  /* حضور تلقائي لخيار اليوم الواحد */
  function ensureTrialAttendance(){
    if (subSelect.value === "trial" && !player.dates.some(d=>d.trial)){
      const trialDate = {
        id: Date.now(),
        date: today(),
        time: "",
        came: true,
        trial: true
      };
      player.dates.push(trialDate);
      appendDateLi(trialDate, datesUL, player);
      saveToStorage();
    }
  }
  ensureTrialAttendance();

  /* تحميل التواريخ السابقة */
  if (player.dates && player.dates.length){
    player.dates.forEach(d=> appendDateLi(d, datesUL, player));
  }

  /* أحداث */
  nameInput.addEventListener("input", ()=>{
    player.name = nameInput.value.trim();
    saveToStorage();
  });

  subSelect.addEventListener("change", ()=>{
    player.subscriptionType = subSelect.value;
    subOtherBox.classList.toggle("hidden", subSelect.value!=="other");
    ensureTrialAttendance();
    saveToStorage();
  });

  subOtherBox.addEventListener("input", ()=>{
    player.subscriptionOther = subOtherBox.value.trim();
    saveToStorage();
  });

  addDateBtn.addEventListener("click", ()=>{
    if (!dateInput.value || !timeInput.value) return;
    const newDate = { id:Date.now(), date:dateInput.value, time:timeInput.value, came:false };
    player.dates.push(newDate);
    appendDateLi(newDate, datesUL, player);
    dateInput.value = today();
    timeInput.value = "";
    saveToStorage();
  });

  card.querySelector(".delete-player").addEventListener("click", ()=>{
    if (confirm(t("deletePlayerConfirm"))){
      players = players.filter(p=>p.id!==player.id);
      card.remove();
      saveToStorage();
    }
  });

  playersContainer.appendChild(card);
}

/* عنصر تمرين */
function appendDateLi(dateObj, ul, playerRef){
  const li = document.createElement("li");
  li.className = "flex justify-between items-center bg-gray-100 rounded-md px-3 py-2";
  li.dataset.dateId = dateObj.id;

  const txt = document.createElement("span");
  txt.textContent = dateObj.trial
    ? t("trialAttendanceText")
    : `${formatDateWithDay(dateObj.date)} - ${t("atTime")} ${dateObj.time}`;

  const actions = document.createElement("div");
  actions.className = "flex items-center gap-3";

  const statusBtn = document.createElement("button");
  statusBtn.className = "text-sm hover:underline";
  toggleStatusAppearance(statusBtn, dateObj.came);
  statusBtn.addEventListener("click", ()=>{
    dateObj.came = !dateObj.came;
    toggleStatusAppearance(statusBtn, dateObj.came);
    saveToStorage();
  });

  const delBtn = document.createElement("button");
  delBtn.textContent = t("deleteTraining");
  delBtn.className = "text-gray-500 hover:text-red-600 text-sm";
  delBtn.addEventListener("click", ()=>{
    if (confirm(t("deleteTrainingConfirm"))){
      playerRef.dates = playerRef.dates.filter(d=>d.id!==dateObj.id);
      li.remove();
      saveToStorage();
    }
  });

  actions.append(statusBtn, delBtn);
  li.append(txt, actions);
  ul.appendChild(li);
}

function toggleStatusAppearance(btn, came){
  btn.textContent = came ? t("came") : t("notCame");
  btn.classList.toggle("text-green-600", came);
  btn.classList.toggle("text-red-500", !came);
}

/* إضافة لاعب جديد */
addBtn.addEventListener("click", ()=>{
  const newP = { id:Date.now(), name:"", subscriptionType:"", subscriptionOther:"", dates:[] };
  players.push(newP);
  saveToStorage();
  renderPlayerCard(newP);
});

/* البحث */
searchInput.addEventListener("input", function(){
  const q = this.value.toLowerCase();
  document.querySelectorAll("#playersContainer > div").forEach(card=>{
    const p = players.find(pl=>pl.id==card.dataset.id);
    card.style.display = p && (p.name||"").toLowerCase().includes(q) ? "block" : "none";
  });
});

/* بناء الواجهة */
updateAppTexts();
players.forEach(renderPlayerCard);
</script>
</body>
</html>
